# .github/workflows/pr-checks.yml
name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch all history for better diff
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run all checks
      run: |
        echo "ğŸ” Running TypeScript type check..."
        npx tsc --noEmit
        
        echo "ğŸ—ï¸ Building application..."
        npm run build
        
        echo "âœ… All checks passed!"
    
    # Comment on PR with build info
    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const output = `
          ## ğŸ¤– CI Results
          
          âœ… Build Status: ${{ job.status }}
          ğŸ“¦ Build completed successfully
          ğŸ” TypeScript checks passed
          
          **Branch:** \`${{ github.head_ref }}\`
          **Commit:** ${{ github.event.pull_request.head.sha }}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

  # Check for merge conflicts
  check-merge-conflict:
    name: Check Merge Conflicts
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for merge conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
          echo "âŒ Merge conflicts detected!"
          exit 1
        else
          echo "âœ… No merge conflicts"
        fi

  # Code size analysis
  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build and analyze
      run: |
        npm run build
        echo "ğŸ“Š Build size analysis:"
        du -sh build
        du -sh build/static/js
        du -sh build/static/css
    
    - name: Comment bundle size
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          const buildSize = execSync('du -sh build').toString().split('\t')[0];
          const jsSize = execSync('du -sh build/static/js').toString().split('\t')[0];
          const cssSize = execSync('du -sh build/static/css').toString().split('\t')[0];
          
          const output = `
          ## ğŸ“Š Bundle Size Report
          
          | Type | Size |
          |------|------|
          | Total Build | ${buildSize} |
          | JavaScript | ${jsSize} |
          | CSS | ${cssSize} |
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })